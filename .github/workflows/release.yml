name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: macos-latest
            target: universal-apple-darwin
            label: macOS-universal
            updater_key: darwin-universal
          - platform: ubuntu-22.04
            target: x86_64-unknown-linux-gnu
            label: Linux-x64
            updater_key: linux-x86_64
          - platform: windows-latest
            target: x86_64-pc-windows-msvc
            label: Windows-x64
            updater_key: windows-x86_64

    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@v4

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target == 'universal-apple-darwin' && 'aarch64-apple-darwin,x86_64-apple-darwin' || matrix.target }}

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: src-tauri

      - name: Install Linux dependencies
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf \
            libgtk-3-dev \
            libsoup-3.0-dev \
            libjavascriptcoregtk-4.1-dev

      - name: Install frontend dependencies
        run: npm ci

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          API_PRIVATE_KEY: ${{ secrets.API_PRIVATE_KEY }}
          PLAYBOOK_PUBLIC_KEY: ${{ secrets.PLAYBOOK_PUBLIC_KEY }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ""
        with:
          tagName: ${{ github.ref_name }}
          releaseName: "Opt-Outta ${{ github.ref_name }}"
          releaseBody: "See the assets below to download and install."
          releaseDraft: false
          prerelease: false
          args: --target ${{ matrix.target }}

      - name: Collect updater artifacts (Unix)
        if: matrix.platform != 'windows-latest'
        id: updater_unix
        shell: bash
        run: |
          echo "=== All .sig files ==="
          find src-tauri/target -name "*.sig" || true

          if [ "${{ matrix.platform }}" = "macos-latest" ]; then
            sig=$(find src-tauri/target -name "*.app.tar.gz.sig" | head -1)
            echo "sig=$sig" >> "$GITHUB_OUTPUT"
          else
            bundle=$(find src-tauri/target -name "*.AppImage.tar.gz" ! -name "*.sig" | head -1)
            sig=$(find src-tauri/target -name "*.AppImage.tar.gz.sig" | head -1)
            echo "bundle=$bundle" >> "$GITHUB_OUTPUT"
            echo "sig=$sig" >> "$GITHUB_OUTPUT"
          fi

      - name: Collect updater artifacts (Windows)
        if: matrix.platform == 'windows-latest'
        id: updater_win
        shell: pwsh
        run: |
          Write-Host "=== All .sig files ==="
          Get-ChildItem -Recurse -Path src-tauri\target -Filter "*.sig" | ForEach-Object { Write-Host $_.FullName }

          $zip = Get-ChildItem -Recurse -Path src-tauri\target -Filter "*.nsis.zip" | Where-Object { $_.Name -notmatch "\.sig$" } | Select-Object -First 1
          $sig = Get-ChildItem -Recurse -Path src-tauri\target -Filter "*.nsis.zip.sig" | Select-Object -First 1

          if ($zip) { "bundle=$($zip.FullName)" | Out-File -Append -FilePath $env:GITHUB_OUTPUT -Encoding utf8 }
          if ($sig) { "sig=$($sig.FullName)" | Out-File -Append -FilePath $env:GITHUB_OUTPUT -Encoding utf8 }

      - name: Upload updater bundles to release
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          tag="${{ github.ref_name }}"
          bundle="${{ steps.updater_unix.outputs.bundle }}${{ steps.updater_win.outputs.bundle }}"
          sig="${{ steps.updater_unix.outputs.sig }}${{ steps.updater_win.outputs.sig }}"

          echo "bundle=$bundle"
          echo "sig=$sig"

          if [ "${{ matrix.platform }}" = "macos-latest" ] && [ -n "$sig" ]; then
            cp "$sig" "Opt-Outta_universal.app.tar.gz.sig"
            gh release upload "$tag" "Opt-Outta_universal.app.tar.gz.sig" --clobber
          fi

          if [ -n "$bundle" ] && [ -f "$bundle" ]; then
            gh release upload "$tag" "$bundle" --clobber
          fi

          if [ "${{ matrix.platform }}" != "macos-latest" ] && [ -n "$sig" ] && [ -f "$sig" ]; then
            gh release upload "$tag" "$sig" --clobber
          fi

      - name: Save signature for updater JSON
        shell: bash
        run: |
          mkdir -p updater-sigs
          sig="${{ steps.updater_unix.outputs.sig }}${{ steps.updater_win.outputs.sig }}"
          if [ -n "$sig" ] && [ -f "$sig" ]; then
            cp "$sig" "updater-sigs/${{ matrix.updater_key }}.sig"
          else
            echo "Warning: no sig file found for ${{ matrix.updater_key }}"
          fi

      - name: Upload sig artifact
        uses: actions/upload-artifact@v4
        with:
          name: updater-sig-${{ matrix.label }}
          path: updater-sigs/

  updater-json:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/download-artifact@v4
        with:
          pattern: updater-sig-*
          merge-multiple: true
          path: sigs

      - name: Create and upload latest.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          tag="${{ github.ref_name }}"
          version="${tag#v}"
          date=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          base="https://github.com/${{ github.repository }}/releases/download/${tag}"

          darwin_sig=""
          linux_sig=""
          windows_sig=""
          [ -f sigs/darwin-universal.sig ] && darwin_sig=$(cat sigs/darwin-universal.sig)
          [ -f sigs/linux-x86_64.sig ] && linux_sig=$(cat sigs/linux-x86_64.sig)
          [ -f sigs/windows-x86_64.sig ] && windows_sig=$(cat sigs/windows-x86_64.sig)

          jq -n \
            --arg version "$version" \
            --arg notes "See the assets below to download and install." \
            --arg pub_date "$date" \
            --arg darwin_sig "$darwin_sig" \
            --arg darwin_url "${base}/Opt-Outta_universal.app.tar.gz" \
            --arg linux_sig "$linux_sig" \
            --arg linux_url "${base}/Opt-Outta_${version}_amd64.AppImage.tar.gz" \
            --arg windows_sig "$windows_sig" \
            --arg windows_url "${base}/Opt-Outta_${version}_x64-setup.nsis.zip" \
            '{
              version: $version,
              notes: $notes,
              pub_date: $pub_date,
              platforms: (
                {}
                + (if $darwin_sig != "" then {"darwin-universal": {signature: $darwin_sig, url: $darwin_url}} else {} end)
                + (if $linux_sig != "" then {"linux-x86_64": {signature: $linux_sig, url: $linux_url}} else {} end)
                + (if $windows_sig != "" then {"windows-x86_64": {signature: $windows_sig, url: $windows_url}} else {} end)
              )
            }' > latest.json

          echo "Generated latest.json:"
          cat latest.json

          gh release upload "$tag" latest.json --clobber --repo "${{ github.repository }}"
