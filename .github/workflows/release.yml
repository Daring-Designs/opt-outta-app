name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  create-release:
    runs-on: ubuntu-latest
    steps:
      - name: Create release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "${{ github.ref_name }}" \
            --title "Opt-Outta ${{ github.ref_name }}" \
            --notes "See the assets below to download and install." \
            --repo "${{ github.repository }}" || true

  build:
    needs: create-release
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: macos-latest
            target: universal-apple-darwin
            label: macOS-universal
            updater_key: darwin-universal
          - platform: ubuntu-22.04
            target: x86_64-unknown-linux-gnu
            label: Linux-x64
            updater_key: linux-x86_64
          - platform: windows-latest
            target: x86_64-pc-windows-msvc
            label: Windows-x64
            updater_key: windows-x86_64

    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@v4

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target == 'universal-apple-darwin' && 'aarch64-apple-darwin,x86_64-apple-darwin' || matrix.target }}

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: src-tauri
          shared-key: ${{ matrix.label }}
          cache-on-failure: true

      - name: Install Linux dependencies
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf \
            libgtk-3-dev \
            libsoup-3.0-dev \
            libjavascriptcoregtk-4.1-dev

      - name: Install frontend dependencies
        run: npm ci

      - name: Build Tauri app
        shell: bash
        env:
          _RAW_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          API_PRIVATE_KEY: ${{ secrets.API_PRIVATE_KEY }}
          PLAYBOOK_PUBLIC_KEY: ${{ secrets.PLAYBOOK_PUBLIC_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ""
        run: |
          # GitHub secrets wrap long base64 lines; reconstruct as two-line minisign key
          FIRST_LINE=$(echo "$_RAW_KEY" | head -n 1)
          REST=$(echo "$_RAW_KEY" | tail -n +2 | tr -d '\n\r\t ')
          printf -v TAURI_SIGNING_PRIVATE_KEY '%s\n%s' "$FIRST_LINE" "$REST"
          export TAURI_SIGNING_PRIVATE_KEY
          echo "Signing key: line1=${#FIRST_LINE} chars, line2=${#REST} chars"
          npx tauri build --target ${{ matrix.target }}

      - name: Upload assets and collect sigs
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          tag="${{ github.ref_name }}"
          version="${tag#v}"
          target="${{ matrix.target }}"
          base="src-tauri/target/${target}/release/bundle"

          echo "=== Bundle directory contents ==="
          ls -R "$base" 2>/dev/null | head -80 || echo "Bundle dir not found at $base"

          mkdir -p updater-sigs

          if [ "${{ matrix.platform }}" = "macos-latest" ]; then
            # Upload .dmg installer
            for f in "$base"/dmg/*.dmg; do
              [ -f "$f" ] && gh release upload "$tag" "$f" --clobber --repo "${{ github.repository }}"
            done

            # Upload updater bundle (.app.tar.gz) and collect sig
            targz="$base/macos/Opt-Outta.app.tar.gz"
            sig="${targz}.sig"
            [ -f "$targz" ] && gh release upload "$tag" "$targz" --clobber --repo "${{ github.repository }}"
            [ -f "$sig" ] && cp "$sig" "updater-sigs/${{ matrix.updater_key }}.sig"
          fi

          if [ "${{ matrix.platform }}" = "ubuntu-22.04" ]; then
            # Upload .deb installer
            for f in "$base"/deb/*.deb; do
              [ -f "$f" ] && gh release upload "$tag" "$f" --clobber --repo "${{ github.repository }}"
            done

            # Upload standalone .AppImage
            for f in "$base"/appimage/*.AppImage; do
              [ -f "$f" ] && gh release upload "$tag" "$f" --clobber --repo "${{ github.repository }}"
            done

            # Upload updater bundle (.AppImage.tar.gz) and collect sig
            targz="$base/appimage/Opt-Outta_${version}_amd64.AppImage.tar.gz"
            sig="${targz}.sig"
            [ -f "$targz" ] && gh release upload "$tag" "$targz" --clobber --repo "${{ github.repository }}"
            [ -f "$sig" ] && cp "$sig" "updater-sigs/${{ matrix.updater_key }}.sig"
          fi

          if [ "${{ matrix.platform }}" = "windows-latest" ]; then
            # Upload .exe installer
            for f in "$base"/nsis/*.exe; do
              [ -f "$f" ] && gh release upload "$tag" "$f" --clobber --repo "${{ github.repository }}"
            done

            # Upload updater bundle (.nsis.zip) and collect sig
            bundle="$base/nsis/Opt-Outta_${version}_x64-setup.nsis.zip"
            sig="${bundle}.sig"
            [ -f "$bundle" ] && gh release upload "$tag" "$bundle" --clobber --repo "${{ github.repository }}"
            [ -f "$sig" ] && cp "$sig" "updater-sigs/${{ matrix.updater_key }}.sig"
          fi

          echo "=== Collected sigs ==="
          ls -la updater-sigs/ || true

      - name: Upload sig artifact
        uses: actions/upload-artifact@v4
        with:
          name: updater-sig-${{ matrix.label }}
          path: updater-sigs/
          if-no-files-found: warn

  updater-json:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/download-artifact@v4
        with:
          pattern: updater-sig-*
          merge-multiple: true
          path: sigs

      - name: List collected sigs
        run: ls -la sigs/ 2>/dev/null || echo "No sigs directory"

      - name: Create and upload latest.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          tag="${{ github.ref_name }}"
          version="${tag#v}"
          date=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          base="https://github.com/${{ github.repository }}/releases/download/${tag}"

          darwin_sig=""
          linux_sig=""
          windows_sig=""
          [ -f sigs/darwin-universal.sig ] && darwin_sig=$(cat sigs/darwin-universal.sig)
          [ -f sigs/linux-x86_64.sig ] && linux_sig=$(cat sigs/linux-x86_64.sig)
          [ -f sigs/windows-x86_64.sig ] && windows_sig=$(cat sigs/windows-x86_64.sig)

          jq -n \
            --arg version "$version" \
            --arg notes "See the assets below to download and install." \
            --arg pub_date "$date" \
            --arg darwin_sig "$darwin_sig" \
            --arg darwin_url "${base}/Opt-Outta.app.tar.gz" \
            --arg linux_sig "$linux_sig" \
            --arg linux_url "${base}/Opt-Outta_${version}_amd64.AppImage.tar.gz" \
            --arg windows_sig "$windows_sig" \
            --arg windows_url "${base}/Opt-Outta_${version}_x64-setup.nsis.zip" \
            '{
              version: $version,
              notes: $notes,
              pub_date: $pub_date,
              platforms: (
                {}
                + (if $darwin_sig != "" then {
                    "darwin-aarch64": {signature: $darwin_sig, url: $darwin_url},
                    "darwin-x86_64": {signature: $darwin_sig, url: $darwin_url},
                    "darwin-universal": {signature: $darwin_sig, url: $darwin_url}
                  } else {} end)
                + (if $linux_sig != "" then {"linux-x86_64": {signature: $linux_sig, url: $linux_url}} else {} end)
                + (if $windows_sig != "" then {"windows-x86_64": {signature: $windows_sig, url: $windows_url}} else {} end)
              )
            }' > latest.json

          echo "Generated latest.json:"
          cat latest.json

          gh release upload "$tag" latest.json --clobber --repo "${{ github.repository }}"
